# Database Migration Guide

## Creating the Initial Migration

After creating the database models, you need to create the initial Alembic migration:

```bash
# Enter the backend container
docker-compose exec backend bash

# Create the initial migration
alembic revision --autogenerate -m "Initial schema"

# Review the generated migration file in alembic/versions/
# Make any necessary adjustments

# Apply the migration
alembic upgrade head
```

## Migration Commands

### Create a new migration
```bash
alembic revision --autogenerate -m "Description of changes"
```

### Apply migrations
```bash
alembic upgrade head
```

### Rollback one migration
```bash
alembic downgrade -1
```

### Rollback to a specific revision
```bash
alembic downgrade <revision_id>
```

### View current revision
```bash
alembic current
```

### View migration history
```bash
alembic history
```

## Important Notes

1. **Always review autogenerated migrations** - Alembic may not catch all changes correctly
2. **Test migrations** - Test on a development database before applying to production
3. **Backup before migrations** - Always backup your database before running migrations
4. **Model imports** - Ensure all models are imported in `alembic/env.py` so Alembic can detect them

## Troubleshooting

### Migration fails with "table already exists"
- The table may have been created manually
- Drop the table or use `alembic stamp head` to mark migrations as applied

### Models not detected
- Ensure models are imported in `app/models/__init__.py`
- Ensure models are imported in `alembic/env.py`

### Foreign key errors during import
- Ensure tables are imported in the correct order (see `data_importer.py` IMPORT_ORDER)
- Check that all referenced tables exist before importing dependent tables

